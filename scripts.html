function toggleImage(img) {
  if (img.classList.contains('enlarged')) {
    // Restore to original position and size
    img.style.position = '';
    img.style.top = '';
    img.style.left = '';
    img.style.transform = '';
    img.style.zIndex = '';
    img.style.boxShadow = '';
    img.style.maxWidth = '';
    img.style.maxHeight = '';
    img.style.width = '';
    img.style.height = '';
    img.classList.remove('enlarged');
    
    // Restore original width
    if (img.dataset.originalWidth) {
      img.style.width = img.dataset.originalWidth;
    }
    
    // Move back to original parent
    if (img.dataset.originalParent) {
      const originalParent = document.querySelector(`[data-original-id="${img.dataset.originalParent}"]`);
      if (originalParent) {
        originalParent.appendChild(img);
      }
    }
    
    // Clean up
    delete img.dataset.originalParent;
    delete img.dataset.originalWidth;
  } else {
    // Store original width
    img.dataset.originalWidth = img.style.width || '';
    
    // Store reference to original parent
    const originalParent = img.parentElement;
    originalParent.setAttribute('data-original-id', Date.now());
    img.dataset.originalParent = originalParent.getAttribute('data-original-id');
    
    // Enlarge and move to body level with viewport constraints
    img.style.position = 'fixed';
    img.style.top = '50%';
    img.style.left = '50%';
    img.style.transform = 'translate(-50%, -50%)';
    img.style.maxWidth = '90vw';
    img.style.maxHeight = '90vh';
    img.style.width = 'auto';
    img.style.height = 'auto';
    img.style.zIndex = '2147483647';
    img.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)';
    img.classList.add('enlarged');
    document.body.appendChild(img);
  }
}

// === ROADMAP FUNCTIONALITY ===
// Only load Plotly on roadmap page to avoid conflicts
if (document.getElementById('roadmap-summary')) {
  // Load Plotly.js dynamically
  const script = document.createElement('script');
  script.src = 'https://cdn.plot.ly/plotly-latest.min.js';
  script.onload = function() {
    initializeRoadmap();
  };
  script.onerror = function() {
    console.error('Failed to load Plotly.js');
    showFallbackMessage('Failed to load charting library');
  };
  document.head.appendChild(script);
}

function showFallbackMessage(message) {
  const elements = ['roadmap-summary', 'roadmap-timeline-chart', 'roadmap-pie-chart', 'roadmap-bar-chart'];
  elements.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.innerHTML = `<p style="color: #e74c3c; text-align: center; padding: 20px;">${message}</p>`;
    }
  });
}

function initializeRoadmap() {
  // Function to create summary statistics
  function createSummary(issues) {
    const totalIssues = issues.length;
    const uniqueLabels = new Set();
    let totalLabels = 0;
    
    issues.forEach(issue => {
      const labels = issue.labels || [];
      labels.forEach(label => {
        uniqueLabels.add(label);
        totalLabels++;
      });
    });
    
    const avgLabelsPerIssue = totalIssues > 0 ? (totalLabels / totalIssues).toFixed(1) : 0;
    
    return {
      totalIssues,
      uniqueLabels: uniqueLabels.size,
      avgLabelsPerIssue
    };
  }

  // Function to count issues by creation date
  function countIssuesByDate(issues) {
    const dateCounts = {};
    
    issues.forEach(issue => {
      if (!issue.created_at) return; // Skip issues without creation date
      
      try {
        const date = new Date(issue.created_at).toISOString().split('T')[0]; // YYYY-MM-DD
        dateCounts[date] = (dateCounts[date] || 0) + 1;
      } catch (error) {
        console.warn('Invalid date format:', issue.created_at);
      }
    });
    
    // Sort dates
    const sortedDates = Object.keys(dateCounts).sort();
    const counts = sortedDates.map(date => dateCounts[date]);
    
    return { dates: sortedDates, counts };
  }

  // Function to create timeline chart
  function createTimelineChart(dateData) {
    const chartElement = document.getElementById('roadmap-timeline-chart');
    if (!chartElement) return;
    
    if (dateData.dates.length === 0) {
      chartElement.innerHTML = '<p style="text-align: center; color: #666;">No date data available for timeline</p>';
      return;
    }
    
    const data = [{
      type: 'scatter',
      mode: 'lines+markers',
      x: dateData.dates,
      y: dateData.counts,
      marker: {
        color: '#4ECDC4',
        size: 6
      },
      line: {
        color: '#4ECDC4',
        width: 2
      },
      hovertemplate: '<b>%{x}</b><br>' +
                     'Issues created: %{y}<br>' +
                     '<extra></extra>'
    }];
    
    const layout = {
      title: {
        text: 'Issues Created Over Time',
        font: { size: 16 }
      },
      xaxis: { 
        title: 'Date',
        type: 'date'
      },
      yaxis: { 
        title: 'Number of Issues Created'
      },
      margin: { t: 60, b: 80, l: 60, r: 40 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)'
    };
    
    const config = { 
      displayModeBar: false,
      responsive: true
    };
    
    Plotly.newPlot('roadmap-timeline-chart', data, layout, config);
  }

  // Function to count label frequency
  function countLabels(issues) {
    const labelCounts = {};
    
    issues.forEach(issue => {
      const labels = issue.labels || [];
      labels.forEach(label => {
        if (label && typeof label === 'string') {
          labelCounts[label] = (labelCounts[label] || 0) + 1;
        }
      });
    });
    
    return labelCounts;
  }

  // Function to create pie chart
  function createPieChart(labelCounts) {
    const chartElement = document.getElementById('roadmap-pie-chart');
    if (!chartElement) return;
    
    const labels = Object.keys(labelCounts);
    const counts = Object.values(labelCounts);
    
    if (labels.length === 0) {
      chartElement.innerHTML = '<p style="text-align: center; color: #666;">No labels found for pie chart</p>';
      return;
    }
    
    const data = [{
      type: 'pie',
      labels: labels,
      values: counts,
      hovertemplate: '<b>%{label}</b><br>' +
                     'Issues: %{value}<br>' +
                     'Percentage: %{percent}<br>' +
                     '<extra></extra>',
      textinfo: 'label+percent',
      textposition: 'auto'
    }];
    
    const layout = {
      title: {
        text: 'Issue Distribution by Label',
        font: { size: 16 }
      },
      margin: { t: 60, b: 40, l: 40, r: 40 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      showlegend: true
    };
    
    const config = { 
      displayModeBar: false,
      responsive: true
    };
    
    Plotly.newPlot('roadmap-pie-chart', data, layout, config);
  }

  // Function to create bar chart
  function createBarChart(labelCounts) {
    const chartElement = document.getElementById('roadmap-bar-chart');
    if (!chartElement) return;
    
    const labels = Object.keys(labelCounts);
    const counts = Object.values(labelCounts);
    
    if (labels.length === 0) {
      chartElement.innerHTML = '<p style="text-align: center; color: #666;">No labels found for bar chart</p>';
      return;
    }
    
    // Sort by count descending
    const sortedData = labels.map((label, index) => ({
      label,
      count: counts[index]
    })).sort((a, b) => b.count - a.count);
    
    const data = [{
      type: 'bar',
      x: sortedData.map(item => item.label),
      y: sortedData.map(item => item.count),
      marker: {
        color: '#4ECDC4',
        opacity: 0.8
      },
      hovertemplate: '<b>%{x}</b><br>' +
                     'Issues: %{y}<br>' +
                     '<extra></extra>'
    }];
    
    const layout = {
      title: {
        text: 'Issue Count by Label',
        font: { size: 16 }
      },
      xaxis: { 
        title: 'Labels',
        tickangle: -45
      },
      yaxis: { 
        title: 'Number of Issues'
      },
      margin: { t: 60, b: 120, l: 60, r: 40 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)'
    };
    
    const config = { 
      displayModeBar: false,
      responsive: true
    };
    
    Plotly.newPlot('roadmap-bar-chart', data, layout, config);
  }

  // Function to try multiple data sources
  async function tryLoadData(urls) {
    for (const url of urls) {
      try {
        console.log(`Attempting to load data from: ${url}`);
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.warn(`Unexpected content type: ${contentType}`);
        }
        
        const data = await response.json();
        console.log(`Successfully loaded data from: ${url}`, data);
        return data;
      } catch (error) {
        console.warn(`Failed to load from ${url}:`, error.message);
        continue;
      }
    }
    throw new Error('All data sources failed');
  }

  // Load and process data
  async function loadRoadmapData() {
    try {
      const response = await fetch('issues.json');
      const issues = await response.json();
      
      if (issues.length === 0) {
        showNoDataMessage();
        return;
      }
      
      console.log(`Loaded ${issues.length} issues`);
      
      // Create summary
      const summary = createSummary(issues);
      const summaryElement = document.getElementById('roadmap-summary');
      if (summaryElement) {
        summaryElement.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <h3 style="margin: 0; color: #4ECDC4; font-size: 2em;">${summary.totalIssues}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Open Issues</p>
            </div>
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <h3 style="margin: 0; color: #4ECDC4; font-size: 2em;">${summary.uniqueLabels}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Unique Labels</p>
            </div>
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <h3 style="margin: 0; color: #4ECDC4; font-size: 2em;">${summary.avgLabelsPerIssue}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Avg Labels per Issue</p>
            </div>
          </div>
        `;
      }
      
      // Create timeline chart
      const dateData = countIssuesByDate(issues);
      createTimelineChart(dateData);
      
      // Create label charts
      const labelCounts = countLabels(issues);
      createPieChart(labelCounts);
      createBarChart(labelCounts);
      
    } catch (error) {
      console.error('Error loading issues data:', error);
      showErrorMessage(error.message);
    }
  }
  
  function showNoDataMessage() {
    const summaryElement = document.getElementById('roadmap-summary');
    if (summaryElement) {
      summaryElement.innerHTML = '<div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; color: #666;"><h3>No Issues Data Available</h3><p>There are no issues to display at this time.</p></div>';
    }
    
    const chartElements = ['roadmap-timeline-chart', 'roadmap-pie-chart', 'roadmap-bar-chart'];
    chartElements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No data available for charts</p>';
      }
    });
  }
  
  function showErrorMessage(errorMsg) {
    const summaryElement = document.getElementById('roadmap-summary');
    if (summaryElement
